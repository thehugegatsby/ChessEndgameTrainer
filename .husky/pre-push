#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Running pre-push hooks..."

# 1. Check for critical vulnerability issues
echo "🔒 Scanning for critical vulnerabilities..."
pnpm audit --audit-level=critical
if [ $? -ne 0 ]; then
  echo "❌ Critical security vulnerabilities found. Push aborted."
  echo "   Run 'pnpm audit fix' to attempt automatic fixes."
  exit 1
fi

# 2. TypeScript type checking (fast, no emit)
echo "📝 Running TypeScript type check..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "❌ TypeScript errors found. Push aborted."
  exit 1
fi

# 3. ESLint validation (without auto-fix)
echo "🔍 Running ESLint validation..."
pnpm run lint
if [ $? -ne 0 ]; then
  echo "❌ ESLint errors found. Push aborted."
  exit 1
fi

# 4. Run test suite
echo "🧪 Running tests..."
pnpm test
if [ $? -ne 0 ]; then
  echo "❌ Tests failed. Push aborted."
  exit 1
fi

echo "✅ All pre-push checks passed. Pushing to remote..."