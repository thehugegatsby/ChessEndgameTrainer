#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push hooks..."

# 1. Check for critical vulnerability issues
echo "ğŸ”’ Scanning for critical vulnerabilities..."
pnpm audit --audit-level=critical
if [ $? -ne 0 ]; then
  echo "âŒ Critical security vulnerabilities found. Push aborted."
  echo "   Run 'pnpm audit fix' to attempt automatic fixes."
  exit 1
fi

# 2. TypeScript type checking (fast, no emit)
echo "ğŸ“ Running TypeScript type check..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Push aborted."
  exit 1
fi

# 3. ESLint validation (without auto-fix)
echo "ğŸ” Running ESLint validation..."
pnpm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint errors found. Push aborted."
  exit 1
fi

# 4. Run test suite
echo "ğŸ§ª Running tests..."
pnpm test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Push aborted."
  exit 1
fi

echo "âœ… All pre-push checks passed. Pushing to remote..."