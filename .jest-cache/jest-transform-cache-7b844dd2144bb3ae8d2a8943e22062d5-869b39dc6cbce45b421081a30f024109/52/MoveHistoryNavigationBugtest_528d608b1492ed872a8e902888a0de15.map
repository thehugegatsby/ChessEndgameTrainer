{"version":3,"sources":["/home/thehu/coolProjects/EndgameTrainer-training-board-complete/src/tests/unit/components/MoveHistoryNavigationBug.test.tsx"],"sourcesContent":["/**\n * Test suite to reproduce the Move History navigation bug\n * Bug: When clicking on a move in history, subsequent moves appear to be deleted\n * Expected: All moves should remain visible, only the position should change\n */\n\nimport React from \"react\";\nimport { render, screen, fireEvent } from \"@testing-library/react\";\nimport { MovePanelZustand } from \"@shared/components/training/MovePanelZustand\";\nimport { useStore } from \"@shared/store/rootStore\";\nimport { createTestValidatedMove } from \"@tests/helpers/validatedMoveFactory\";\nimport type { ValidatedMove } from \"@shared/types/chess\";\n\n// Mock the store hooks\njest.mock(\"@shared/store/hooks\", () => ({\n  useGameStore: jest.fn(),\n  useTablebaseStore: jest.fn(),\n  useTrainingStore: jest.fn(),\n}));\n\nconst mockUseGameStore = jest.requireMock(\"@shared/store/hooks\").useGameStore;\nconst mockUseTablebaseStore = jest.requireMock(\n  \"@shared/store/hooks\",\n).useTablebaseStore;\nconst mockUseTrainingStore = jest.requireMock(\n  \"@shared/store/hooks\",\n).useTrainingStore;\n\ndescribe(\"Move History Navigation Bug\", () => {\n  /**\n   *\n   */\n  const createMockMoves = (): ValidatedMove[] => [\n    createTestValidatedMove({\n      from: \"e2\",\n      to: \"e4\",\n      san: \"e4\",\n      color: \"w\",\n      piece: \"p\",\n    }),\n    createTestValidatedMove({\n      from: \"e7\",\n      to: \"e5\",\n      san: \"e5\",\n      color: \"b\",\n      piece: \"p\",\n    }),\n    createTestValidatedMove({\n      from: \"g1\",\n      to: \"f3\",\n      san: \"Nf3\",\n      color: \"w\",\n      piece: \"n\",\n    }),\n    createTestValidatedMove({\n      from: \"b8\",\n      to: \"c6\",\n      san: \"Nc6\",\n      color: \"b\",\n      piece: \"n\",\n    }),\n    createTestValidatedMove({\n      from: \"f1\",\n      to: \"c4\",\n      san: \"Bc4\",\n      color: \"w\",\n      piece: \"b\",\n    }),\n  ];\n\n  beforeEach(() => {\n    // Setup default mock returns\n    mockUseTablebaseStore.mockReturnValue([\n      {\n        evaluations: [],\n      },\n      {},\n    ]);\n\n    mockUseTrainingStore.mockReturnValue([\n      {\n        currentPosition: null,\n      },\n      {},\n    ]);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  it(\"FIX VERIFICATION: Should show ALL moves even when navigating to an earlier move\", () => {\n    const mockMoves = createMockMoves();\n    const onMoveClick = jest.fn();\n\n    // Initial state: All 5 moves played, viewing the last move (index 4)\n    mockUseGameStore.mockReturnValue([\n      {\n        moveHistory: mockMoves,\n        currentMoveIndex: 4, // Viewing the last move\n        currentFen: \"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1\",\n      },\n      {},\n    ]);\n\n    const { rerender } = render(\n      <MovePanelZustand onMoveClick={onMoveClick} currentMoveIndex={4} />,\n    );\n\n    // Verify all 5 moves are displayed initially\n    expect(screen.getByText(\"e4\")).toBeInTheDocument();\n    expect(screen.getByText(\"e5\")).toBeInTheDocument();\n    expect(screen.getByText(\"Nf3\")).toBeInTheDocument();\n    expect(screen.getByText(\"Nc6\")).toBeInTheDocument();\n    expect(screen.getByText(\"Bc4\")).toBeInTheDocument();\n\n    // User clicks on move 2 (Nf3) to navigate there\n    const nf3Button = screen.getByText(\"Nf3\");\n    fireEvent.click(nf3Button);\n    expect(onMoveClick).toHaveBeenCalledWith(2);\n\n    // Simulate the state update after navigation\n    // The bug is that currentMoveIndex changes to 2\n    mockUseGameStore.mockReturnValue([\n      {\n        moveHistory: mockMoves, // All moves still in history\n        currentMoveIndex: 2, // Now viewing move 2\n        currentFen: \"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1\",\n      },\n      {},\n    ]);\n\n    rerender(\n      <MovePanelZustand onMoveClick={onMoveClick} currentMoveIndex={2} />,\n    );\n\n    // FIX VERIFICATION: After the fix, ALL moves should remain visible\n    // when navigating to an earlier move\n\n    console.log(\"\\n=== FIX VERIFICATION ===\");\n    console.log(\"After clicking on move 2 (Nf3):\");\n    console.log(\"Expected: All 5 moves visible (e4, e5, Nf3, Nc6, Bc4)\");\n    console.log(\"With fix: All moves should now be visible!\");\n\n    // These assertions verify the fix works:\n    expect(screen.getByText(\"e4\")).toBeInTheDocument();\n    expect(screen.getByText(\"e5\")).toBeInTheDocument();\n    expect(screen.getByText(\"Nf3\")).toBeInTheDocument();\n\n    // FIXED: These moves should now be visible!\n    expect(screen.getByText(\"Nc6\")).toBeInTheDocument(); // Now visible!\n    expect(screen.getByText(\"Bc4\")).toBeInTheDocument(); // Now visible!\n  });\n\n  it(\"EXPECTED BEHAVIOR: Should display all moves with proper highlighting\", () => {\n    const mockMoves = createMockMoves();\n    const onMoveClick = jest.fn();\n\n    // This test shows what SHOULD happen\n    mockUseGameStore.mockReturnValue([\n      {\n        moveHistory: mockMoves,\n        currentMoveIndex: 2, // Viewing move 2, but all moves in history\n        currentFen: \"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1\",\n      },\n      {},\n    ]);\n\n    // If the bug was fixed, this is what we'd see:\n    console.log(\"\\n=== EXPECTED BEHAVIOR ===\");\n    console.log(\"When viewing move 2:\");\n    console.log(\"- All 5 moves should be visible\");\n    console.log(\"- Move 3 (Nf3) should be highlighted as current\");\n    console.log(\"- Moves 4-5 (Nc6, Bc4) should appear grayed out or different\");\n    console.log(\"- User can click any move to jump there\");\n  });\n\n  it(\"Verifies the actual data flow\", () => {\n    const mockMoves = createMockMoves();\n\n    // Log the actual data to understand the bug\n    console.log(\"\\n=== DATA FLOW ANALYSIS ===\");\n    console.log(\"1. Initial state:\");\n    console.log(`   - moveHistory.length: ${mockMoves.length}`);\n    console.log(`   - currentMoveIndex: 4`);\n    console.log(`   - All moves: ${mockMoves.map((m) => m.san).join(\", \")}`);\n\n    console.log(\"\\n2. After clicking move 2:\");\n    console.log(`   - moveHistory.length: ${mockMoves.length} (unchanged)`);\n    console.log(`   - currentMoveIndex: 2 (changed)`);\n    console.log(\n      `   - All moves still in store: ${mockMoves.map((m) => m.san).join(\", \")}`,\n    );\n\n    console.log(\"\\n3. Bug in MovePanelZustand:\");\n    console.log(\"   - Line 160-162 slices moveHistory:\");\n    console.log(\"     gameState.moveHistory.slice(0, currentMoveIndex + 1)\");\n    console.log(`   - This creates: slice(0, 3) = first 3 moves only`);\n    console.log(\"   - Result: Moves 4-5 disappear from UI!\");\n  });\n});\n"],"names":["jest","mock","useGameStore","fn","useTablebaseStore","useTrainingStore","mockUseGameStore","requireMock","mockUseTablebaseStore","mockUseTrainingStore","describe","createMockMoves","createTestValidatedMove","from","to","san","color","piece","beforeEach","mockReturnValue","evaluations","currentPosition","afterEach","clearAllMocks","it","mockMoves","onMoveClick","moveHistory","currentMoveIndex","currentFen","rerender","render","MovePanelZustand","expect","screen","getByText","toBeInTheDocument","nf3Button","fireEvent","click","toHaveBeenCalledWith","console","log","length","map","m","join"],"mappings":"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"}