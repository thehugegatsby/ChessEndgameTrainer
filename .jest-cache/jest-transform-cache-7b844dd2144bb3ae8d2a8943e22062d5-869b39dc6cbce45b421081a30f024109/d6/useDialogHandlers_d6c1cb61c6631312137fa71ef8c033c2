14163c3567fd38a9f66a144c68c3762a
/**
 * @file Dialog handlers hook for chess training board
 * @module hooks/useDialogHandlers
 * 
 * @description
 * Custom hook that encapsulates all dialog handling logic for chess training.
 * Extracted from TrainingBoard to separate dialog business logic from UI coordination.
 * Handles error dialogs, success dialogs, and training workflow actions.
 * 
 * @remarks
 * Key responsibilities:
 * - Move error dialog actions (take back, restart, continue, show best move)
 * - Move success dialog actions (close, continue)
 * - Training session reset coordination
 * - Complex opponent turn scheduling and cancellation
 * - Comprehensive logging and state coordination
 * 
 * This hook maintains all the complex business logic while providing
 * a clean interface for dialog action coordination.
 * 
 * @example
 * ```tsx
 * const dialogHandlers = useDialogHandlers({
 *   undoMove,
 *   resetGame,
 *   clearEvaluations,
 *   trainingActions,
 *   gameActions,
 *   uiActions,
 *   trainingState,
 *   storeApi,
 *   trainingUIState,
 * });
 * 
 * <DialogManager
 *   errorDialog={trainingState.moveErrorDialog}
 *   successDialog={trainingState.moveSuccessDialog}
 *   onErrorTakeBack={dialogHandlers.handleMoveErrorTakeBack}
 *   onErrorRestart={dialogHandlers.handleMoveErrorRestart}
 *   onErrorContinue={dialogHandlers.handleMoveErrorContinue}
 *   onErrorShowBestMove={dialogHandlers.handleShowBestMove}
 *   onSuccessClose={dialogHandlers.handleMoveSuccessClose}
 *   onSuccessContinue={dialogHandlers.handleMoveSuccessContinue}
 * />
 * ```
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "useDialogHandlers", {
    enumerable: true,
    get: function() {
        return useDialogHandlers;
    }
});
const _react = require("react");
const _Logger = require("../services/logging/Logger");
const _handlePlayerMove = require("../store/orchestrators/handlePlayerMove");
const _ChessService = require("../services/ChessService");
const _TablebaseService = require("../services/TablebaseService");
const useDialogHandlers = ({ undoMove, resetGame, clearEvaluations, trainingActions, gameActions, uiActions, trainingState, storeApi, trainingUIState })=>{
    /**
   * Resets the training board to initial state
   *
   * @description
   * Performs comprehensive cleanup including:
   * - Resetting chess game to starting position
   * - Clearing all position evaluations
   * - Resetting UI state and dialogs
   * - Clearing training session data
   *
   * @remarks
   * This handler is called when:
   * - User clicks reset button
   * - Training session needs restart
   * - Parent component triggers reset
   */ const handleReset = (0, _react.useCallback)(()=>{
        resetGame();
        clearEvaluations();
        trainingUIState.handleReset();
        gameActions.resetGame();
        // Clear evaluation baseline when resetting
        trainingActions.clearEvaluationBaseline();
    }, [
        resetGame,
        clearEvaluations,
        gameActions,
        trainingUIState,
        trainingActions
    ]);
    /**
   * Handles move error dialog dismissal with undo
   *
   * @description
   * Closes the move error dialog and undoes the suboptimal move,
   * allowing the user to try a different move.
   *
   * @remarks
   * When a suboptimal move is detected, it has already been executed
   * on the board and added to the move history. This function removes
   * the move from history and reverts the board position.
   */ const handleMoveErrorTakeBack = (0, _react.useCallback)(()=>{
        const logger = (0, _Logger.getLogger)().setContext("useDialogHandlers-MoveError");
        logger.info("Undoing suboptimal move using useTrainingSession undoMove");
        // CRITICAL: Cancel any scheduled opponent turn BEFORE undoing
        // This prevents the opponent from playing after we undo
        (0, _handlePlayerMove.cancelScheduledOpponentTurn)();
        logger.info("Cancelled any scheduled opponent turn");
        // Use the undoMove function from useTrainingSession which properly handles ChessService
        const undoResult = undoMove();
        if (undoResult) {
            logger.info("Move successfully undone");
            // CRITICAL: Set player turn to true after undoing a suboptimal move
            // This prevents the opponent from playing immediately after undo
            logger.debug("Before setPlayerTurn - current state", {
                isPlayerTurn: trainingState.isPlayerTurn,
                isOpponentThinking: trainingState.isOpponentThinking
            });
            trainingActions.setPlayerTurn(true);
            trainingActions.clearOpponentThinking(); // Clear opponent thinking flag
            trainingActions.clearEvaluationBaseline(); // Clear baseline since we're back to original position
            logger.info("Set player turn to true, cleared opponent thinking, and cleared evaluation baseline");
            logger.debug("After setPlayerTurn call");
        } else {
            logger.error("Failed to undo move - no moves in history");
        }
        // Close the dialog using the trainingActions hook which properly accesses the action
        // The hook extracts the action from the slice creator, not from the nested store state
        if (trainingActions && trainingActions.setMoveErrorDialog) {
            trainingActions.setMoveErrorDialog(null);
            logger.info("Successfully closed move error dialog via trainingActions hook");
        } else {
            logger.error("setMoveErrorDialog not available in trainingActions");
        }
    }, [
        undoMove,
        trainingActions,
        trainingState
    ]);
    /**
   * Restarts the entire training session after move error
   *
   * @description
   * Completely resets the game and closes the error dialog when
   * the user chooses to restart after making a critical mistake.
   *
   * @remarks
   * This is typically used when the user has made a game-losing
   * mistake and wants to start the position from the beginning.
   */ const handleMoveErrorRestart = (0, _react.useCallback)(()=>{
        const logger = (0, _Logger.getLogger)().setContext("useDialogHandlers-MoveError");
        logger.info("Restarting game due to move error");
        handleReset();
        trainingActions.setMoveErrorDialog(null);
    }, [
        handleReset,
        trainingActions
    ]);
    /**
   * Handles "Weiterspielen" (continue playing) action from error dialog
   *
   * @description
   * Closes the error dialog and schedules the opponent's turn.
   * This allows the game to continue even after a suboptimal move,
   * letting the opponent respond to the player's move.
   *
   * @remarks
   * This provides a smoother training experience by allowing players
   * to continue playing and learning from their mistakes rather than
   * always having to take back moves.
   */ const handleMoveErrorContinue = (0, _react.useCallback)(()=>{
        var _currentState_training_currentPosition, _currentState_training_currentPosition_colorToTrain, _currentState_training_currentPosition1;
        const logger = (0, _Logger.getLogger)().setContext("useDialogHandlers-MoveError");
        // Get current state for debugging
        const currentState = storeApi.getState();
        logger.info("🎯 WEITERSPIELEN clicked - Current state BEFORE action:", {
            isPlayerTurn: currentState.training.isPlayerTurn,
            isOpponentThinking: currentState.training.isOpponentThinking,
            currentFen: _ChessService.chessService.getFen(),
            currentTurn: _ChessService.chessService.turn(),
            colorToTrain: (_currentState_training_currentPosition = currentState.training.currentPosition) === null || _currentState_training_currentPosition === void 0 ? void 0 : _currentState_training_currentPosition.colorToTrain,
            moveCount: currentState.game.moveHistory.length
        });
        // CRITICAL FIX: Set turn state before scheduling opponent turn
        // This ensures the opponent can actually execute their move
        const currentTurn = _ChessService.chessService.turn();
        const trainingColor = (_currentState_training_currentPosition1 = currentState.training.currentPosition) === null || _currentState_training_currentPosition1 === void 0 ? void 0 : (_currentState_training_currentPosition_colorToTrain = _currentState_training_currentPosition1.colorToTrain) === null || _currentState_training_currentPosition_colorToTrain === void 0 ? void 0 : _currentState_training_currentPosition_colorToTrain.charAt(0);
        if (currentTurn !== trainingColor) {
            logger.info("🔧 FIXING BUG: Setting isPlayerTurn=false for opponent to move");
            trainingActions.setPlayerTurn(false);
        }
        // Close the error dialog
        trainingActions.setMoveErrorDialog(null);
        logger.info("✅ Error dialog closed");
        // Schedule opponent turn to respond to player's move
        logger.info("📅 Calling scheduleOpponentTurn with evaluation baseline callback...");
        (0, _handlePlayerMove.scheduleOpponentTurn)(storeApi, 500, {
            onOpponentMoveComplete: async ()=>{
                logger.info("🎯 Opponent move completed - updating evaluation baseline");
                try {
                    // Get current position evaluation
                    const currentFen = _ChessService.chessService.getFen();
                    const currentEval = await _TablebaseService.tablebaseService.getEvaluation(currentFen);
                    if (currentEval.isAvailable && currentEval.result) {
                        // Update baseline to current position's evaluation using the actions provided to this hook
                        trainingActions.setEvaluationBaseline(currentEval.result.wdl, currentFen);
                        logger.info("✅ Evaluation baseline updated successfully", {
                            newBaseline: currentEval.result.wdl,
                            fen: currentFen
                        });
                    } else {
                        logger.warn("⚠️ Could not get evaluation for baseline update - tablebase unavailable");
                    }
                } catch (error) {
                    logger.error("❌ Failed to update evaluation baseline:", error);
                }
            }
        });
        // Check state after scheduling
        const stateAfter = storeApi.getState();
        logger.info("📊 State AFTER scheduling opponent turn:", {
            isPlayerTurn: stateAfter.training.isPlayerTurn,
            isOpponentThinking: stateAfter.training.isOpponentThinking
        });
    }, [
        trainingActions,
        storeApi
    ]);
    /**
   * Displays the best move as a toast notification
   *
   * @description
   * Shows the optimal move in a toast message when the user
   * requests to see the best move after making a mistake.
   *
   * @remarks
   * The best move is determined by tablebase analysis and
   * represents the objectively best continuation from the
   * position before the user's suboptimal move.
   */ const handleShowBestMove = (0, _react.useCallback)(()=>{
        var _trainingState_moveErrorDialog;
        if ((_trainingState_moveErrorDialog = trainingState.moveErrorDialog) === null || _trainingState_moveErrorDialog === void 0 ? void 0 : _trainingState_moveErrorDialog.bestMove) {
            const logger = (0, _Logger.getLogger)().setContext("useDialogHandlers-MoveError");
            logger.info("Showing best move", {
                bestMove: trainingState.moveErrorDialog.bestMove
            });
            uiActions.showToast(`Der beste Zug war: ${trainingState.moveErrorDialog.bestMove}`, "info");
        }
        trainingActions.setMoveErrorDialog(null);
    }, [
        trainingState.moveErrorDialog,
        uiActions,
        trainingActions
    ]);
    /**
   * Handles success dialog close
   *
   * @description
   * Closes the move success dialog when user dismisses it.
   */ const handleMoveSuccessClose = (0, _react.useCallback)(()=>{
        trainingActions.setMoveSuccessDialog(null);
    }, [
        trainingActions
    ]);
    /**
   * Handles continuing to next position after success
   *
   * @description
   * Closes the success dialog and allows training to continue.
   * Training completion logic is handled elsewhere in the system.
   */ const handleMoveSuccessContinue = (0, _react.useCallback)(()=>{
        trainingActions.setMoveSuccessDialog(null);
    // Training completion logic is already handled by PawnPromotionHandler
    }, [
        trainingActions
    ]);
    return {
        handleMoveErrorTakeBack,
        handleMoveErrorRestart,
        handleMoveErrorContinue,
        handleShowBestMove,
        handleMoveSuccessClose,
        handleMoveSuccessContinue,
        handleReset
    };
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3RoZWh1L2Nvb2xQcm9qZWN0cy9FbmRnYW1lVHJhaW5lci10cmFpbmluZy1ib2FyZC1jb21wbGV0ZS9zcmMvc2hhcmVkL2hvb2tzL3VzZURpYWxvZ0hhbmRsZXJzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgRGlhbG9nIGhhbmRsZXJzIGhvb2sgZm9yIGNoZXNzIHRyYWluaW5nIGJvYXJkXG4gKiBAbW9kdWxlIGhvb2tzL3VzZURpYWxvZ0hhbmRsZXJzXG4gKiBcbiAqIEBkZXNjcmlwdGlvblxuICogQ3VzdG9tIGhvb2sgdGhhdCBlbmNhcHN1bGF0ZXMgYWxsIGRpYWxvZyBoYW5kbGluZyBsb2dpYyBmb3IgY2hlc3MgdHJhaW5pbmcuXG4gKiBFeHRyYWN0ZWQgZnJvbSBUcmFpbmluZ0JvYXJkIHRvIHNlcGFyYXRlIGRpYWxvZyBidXNpbmVzcyBsb2dpYyBmcm9tIFVJIGNvb3JkaW5hdGlvbi5cbiAqIEhhbmRsZXMgZXJyb3IgZGlhbG9ncywgc3VjY2VzcyBkaWFsb2dzLCBhbmQgdHJhaW5pbmcgd29ya2Zsb3cgYWN0aW9ucy5cbiAqIFxuICogQHJlbWFya3NcbiAqIEtleSByZXNwb25zaWJpbGl0aWVzOlxuICogLSBNb3ZlIGVycm9yIGRpYWxvZyBhY3Rpb25zICh0YWtlIGJhY2ssIHJlc3RhcnQsIGNvbnRpbnVlLCBzaG93IGJlc3QgbW92ZSlcbiAqIC0gTW92ZSBzdWNjZXNzIGRpYWxvZyBhY3Rpb25zIChjbG9zZSwgY29udGludWUpXG4gKiAtIFRyYWluaW5nIHNlc3Npb24gcmVzZXQgY29vcmRpbmF0aW9uXG4gKiAtIENvbXBsZXggb3Bwb25lbnQgdHVybiBzY2hlZHVsaW5nIGFuZCBjYW5jZWxsYXRpb25cbiAqIC0gQ29tcHJlaGVuc2l2ZSBsb2dnaW5nIGFuZCBzdGF0ZSBjb29yZGluYXRpb25cbiAqIFxuICogVGhpcyBob29rIG1haW50YWlucyBhbGwgdGhlIGNvbXBsZXggYnVzaW5lc3MgbG9naWMgd2hpbGUgcHJvdmlkaW5nXG4gKiBhIGNsZWFuIGludGVyZmFjZSBmb3IgZGlhbG9nIGFjdGlvbiBjb29yZGluYXRpb24uXG4gKiBcbiAqIEBleGFtcGxlXG4gKiBgYGB0c3hcbiAqIGNvbnN0IGRpYWxvZ0hhbmRsZXJzID0gdXNlRGlhbG9nSGFuZGxlcnMoe1xuICogICB1bmRvTW92ZSxcbiAqICAgcmVzZXRHYW1lLFxuICogICBjbGVhckV2YWx1YXRpb25zLFxuICogICB0cmFpbmluZ0FjdGlvbnMsXG4gKiAgIGdhbWVBY3Rpb25zLFxuICogICB1aUFjdGlvbnMsXG4gKiAgIHRyYWluaW5nU3RhdGUsXG4gKiAgIHN0b3JlQXBpLFxuICogICB0cmFpbmluZ1VJU3RhdGUsXG4gKiB9KTtcbiAqIFxuICogPERpYWxvZ01hbmFnZXJcbiAqICAgZXJyb3JEaWFsb2c9e3RyYWluaW5nU3RhdGUubW92ZUVycm9yRGlhbG9nfVxuICogICBzdWNjZXNzRGlhbG9nPXt0cmFpbmluZ1N0YXRlLm1vdmVTdWNjZXNzRGlhbG9nfVxuICogICBvbkVycm9yVGFrZUJhY2s9e2RpYWxvZ0hhbmRsZXJzLmhhbmRsZU1vdmVFcnJvclRha2VCYWNrfVxuICogICBvbkVycm9yUmVzdGFydD17ZGlhbG9nSGFuZGxlcnMuaGFuZGxlTW92ZUVycm9yUmVzdGFydH1cbiAqICAgb25FcnJvckNvbnRpbnVlPXtkaWFsb2dIYW5kbGVycy5oYW5kbGVNb3ZlRXJyb3JDb250aW51ZX1cbiAqICAgb25FcnJvclNob3dCZXN0TW92ZT17ZGlhbG9nSGFuZGxlcnMuaGFuZGxlU2hvd0Jlc3RNb3ZlfVxuICogICBvblN1Y2Nlc3NDbG9zZT17ZGlhbG9nSGFuZGxlcnMuaGFuZGxlTW92ZVN1Y2Nlc3NDbG9zZX1cbiAqICAgb25TdWNjZXNzQ29udGludWU9e2RpYWxvZ0hhbmRsZXJzLmhhbmRsZU1vdmVTdWNjZXNzQ29udGludWV9XG4gKiAvPlxuICogYGBgXG4gKi9cblxuaW1wb3J0IHsgdXNlQ2FsbGJhY2sgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBnZXRMb2dnZXIgfSBmcm9tICdAc2hhcmVkL3NlcnZpY2VzL2xvZ2dpbmcvTG9nZ2VyJztcbmltcG9ydCB7XG4gIGNhbmNlbFNjaGVkdWxlZE9wcG9uZW50VHVybixcbiAgc2NoZWR1bGVPcHBvbmVudFR1cm4sXG59IGZyb20gJ0BzaGFyZWQvc3RvcmUvb3JjaGVzdHJhdG9ycy9oYW5kbGVQbGF5ZXJNb3ZlJztcbmltcG9ydCB7IGNoZXNzU2VydmljZSB9IGZyb20gJ0BzaGFyZWQvc2VydmljZXMvQ2hlc3NTZXJ2aWNlJztcbmltcG9ydCB7IHRhYmxlYmFzZVNlcnZpY2UgfSBmcm9tICdAc2hhcmVkL3NlcnZpY2VzL1RhYmxlYmFzZVNlcnZpY2UnO1xuaW1wb3J0IHR5cGUgeyBTdG9yZUFwaSB9IGZyb20gJ0BzaGFyZWQvc3RvcmUvU3RvcmVDb250ZXh0JztcblxuLyoqXG4gKiBUcmFpbmluZyBhY3Rpb25zIGludGVyZmFjZSAoc3Vic2V0IG5lZWRlZCBmb3IgZGlhbG9nIGhhbmRsaW5nKVxuICovXG5pbnRlcmZhY2UgVHJhaW5pbmdBY3Rpb25zU3Vic2V0IHtcbiAgc2V0UGxheWVyVHVybjogKGlzUGxheWVyVHVybjogYm9vbGVhbikgPT4gdm9pZDtcbiAgY2xlYXJPcHBvbmVudFRoaW5raW5nOiAoKSA9PiB2b2lkO1xuICBzZXRNb3ZlRXJyb3JEaWFsb2c6IChkaWFsb2c6IGFueSkgPT4gdm9pZDtcbiAgc2V0TW92ZVN1Y2Nlc3NEaWFsb2c6IChkaWFsb2c6IGFueSkgPT4gdm9pZDtcbiAgc2V0RXZhbHVhdGlvbkJhc2VsaW5lOiAod2RsOiBudW1iZXIsIGZlbjogc3RyaW5nKSA9PiB2b2lkO1xuICBjbGVhckV2YWx1YXRpb25CYXNlbGluZTogKCkgPT4gdm9pZDtcbn1cblxuLyoqXG4gKiBHYW1lIGFjdGlvbnMgaW50ZXJmYWNlIChzdWJzZXQgbmVlZGVkIGZvciBkaWFsb2cgaGFuZGxpbmcpXG4gKi9cbmludGVyZmFjZSBHYW1lQWN0aW9uc1N1YnNldCB7XG4gIHJlc2V0R2FtZTogKCkgPT4gdm9pZDtcbn1cblxuLyoqXG4gKiBVSSBhY3Rpb25zIGludGVyZmFjZSAoc3Vic2V0IG5lZWRlZCBmb3IgZGlhbG9nIGhhbmRsaW5nKVxuICovXG5pbnRlcmZhY2UgVUlBY3Rpb25zU3Vic2V0IHtcbiAgc2hvd1RvYXN0OiAobWVzc2FnZTogc3RyaW5nLCB0eXBlOiBzdHJpbmcpID0+IHZvaWQ7XG59XG5cbi8qKlxuICogVHJhaW5pbmcgc3RhdGUgaW50ZXJmYWNlIChzdWJzZXQgbmVlZGVkIGZvciBkaWFsb2cgaGFuZGxpbmcpXG4gKi9cbmludGVyZmFjZSBUcmFpbmluZ1N0YXRlU3Vic2V0IHtcbiAgaXNQbGF5ZXJUdXJuOiBib29sZWFuO1xuICBpc09wcG9uZW50VGhpbmtpbmc6IGJvb2xlYW47XG4gIGN1cnJlbnRQb3NpdGlvbj86IHtcbiAgICBpZDogbnVtYmVyO1xuICAgIGNvbG9yVG9UcmFpbj86IHN0cmluZztcbiAgfSB8IG51bGw7XG4gIG1vdmVFcnJvckRpYWxvZz86IHtcbiAgICBiZXN0TW92ZT86IHN0cmluZztcbiAgfSB8IG51bGw7XG59XG5cblxuLyoqXG4gKiBUcmFpbmluZyBVSSBzdGF0ZSBpbnRlcmZhY2UgKHN1YnNldCBuZWVkZWQgZm9yIGRpYWxvZyBoYW5kbGluZylcbiAqL1xuaW50ZXJmYWNlIFRyYWluaW5nVUlTdGF0ZVN1YnNldCB7XG4gIGhhbmRsZVJlc2V0OiAoKSA9PiB2b2lkO1xufVxuXG4vKipcbiAqIFByb3BzIGZvciB1c2VEaWFsb2dIYW5kbGVycyBob29rXG4gKi9cbmludGVyZmFjZSBVc2VEaWFsb2dIYW5kbGVyc1Byb3BzIHtcbiAgLyoqIFRyYWluaW5nIHNlc3Npb24gZnVuY3Rpb24gdG8gdW5kbyBtb3ZlcyAqL1xuICB1bmRvTW92ZTogKCkgPT4gYm9vbGVhbjtcbiAgLyoqIFRyYWluaW5nIHNlc3Npb24gZnVuY3Rpb24gdG8gcmVzZXQgZ2FtZSAqL1xuICByZXNldEdhbWU6ICgpID0+IHZvaWQ7XG4gIC8qKiBUcmFpbmluZyBzZXNzaW9uIGZ1bmN0aW9uIHRvIGNsZWFyIGV2YWx1YXRpb25zICovXG4gIGNsZWFyRXZhbHVhdGlvbnM6ICgpID0+IHZvaWQ7XG4gIFxuICAvKiogVHJhaW5pbmcgc3RvcmUgYWN0aW9ucyAqL1xuICB0cmFpbmluZ0FjdGlvbnM6IFRyYWluaW5nQWN0aW9uc1N1YnNldDtcbiAgLyoqIEdhbWUgc3RvcmUgYWN0aW9ucyAqL1xuICBnYW1lQWN0aW9uczogR2FtZUFjdGlvbnNTdWJzZXQ7XG4gIC8qKiBVSSBzdG9yZSBhY3Rpb25zICovXG4gIHVpQWN0aW9uczogVUlBY3Rpb25zU3Vic2V0O1xuICBcbiAgLyoqIFRyYWluaW5nIHN0YXRlICovXG4gIHRyYWluaW5nU3RhdGU6IFRyYWluaW5nU3RhdGVTdWJzZXQ7XG4gIFxuICAvKiogU3RvcmUgQVBJIGZvciBkaXJlY3Qgc3RhdGUgYWNjZXNzICovXG4gIHN0b3JlQXBpOiBTdG9yZUFwaTtcbiAgXG4gIC8qKiBUcmFpbmluZyBVSSBzdGF0ZSBtYW5hZ2VtZW50ICovXG4gIHRyYWluaW5nVUlTdGF0ZTogVHJhaW5pbmdVSVN0YXRlU3Vic2V0O1xufVxuXG4vKipcbiAqIFJldHVybiB2YWx1ZSBmcm9tIHVzZURpYWxvZ0hhbmRsZXJzIGhvb2tcbiAqL1xuaW50ZXJmYWNlIFVzZURpYWxvZ0hhbmRsZXJzUmV0dXJuIHtcbiAgLyoqIEhhbmRsZXIgZm9yIG1vdmUgZXJyb3IgZGlhbG9nIC0gdGFrZSBiYWNrIG1vdmUgKHVuZG8pICovXG4gIGhhbmRsZU1vdmVFcnJvclRha2VCYWNrOiAoKSA9PiB2b2lkO1xuICAvKiogSGFuZGxlciBmb3IgbW92ZSBlcnJvciBkaWFsb2cgLSByZXN0YXJ0IGdhbWUgKi9cbiAgaGFuZGxlTW92ZUVycm9yUmVzdGFydDogKCkgPT4gdm9pZDtcbiAgLyoqIEhhbmRsZXIgZm9yIG1vdmUgZXJyb3IgZGlhbG9nIC0gY29udGludWUgcGxheWluZyAqL1xuICBoYW5kbGVNb3ZlRXJyb3JDb250aW51ZTogKCkgPT4gdm9pZDtcbiAgLyoqIEhhbmRsZXIgZm9yIG1vdmUgZXJyb3IgZGlhbG9nIC0gc2hvdyBiZXN0IG1vdmUgKi9cbiAgaGFuZGxlU2hvd0Jlc3RNb3ZlOiAoKSA9PiB2b2lkO1xuICBcbiAgLyoqIEhhbmRsZXIgZm9yIG1vdmUgc3VjY2VzcyBkaWFsb2cgLSBjbG9zZSBkaWFsb2cgKi9cbiAgaGFuZGxlTW92ZVN1Y2Nlc3NDbG9zZTogKCkgPT4gdm9pZDtcbiAgLyoqIEhhbmRsZXIgZm9yIG1vdmUgc3VjY2VzcyBkaWFsb2cgLSBjb250aW51ZSB0byBuZXh0ICovXG4gIGhhbmRsZU1vdmVTdWNjZXNzQ29udGludWU6ICgpID0+IHZvaWQ7XG4gIFxuICAvKiogSGFuZGxlciBmb3IgZ2VuZXJhbCBnYW1lIHJlc2V0ICovXG4gIGhhbmRsZVJlc2V0OiAoKSA9PiB2b2lkO1xufVxuXG4vKipcbiAqIEN1c3RvbSBob29rIGZvciBjaGVzcyBkaWFsb2cgaGFuZGxpbmcgbG9naWNcbiAqIFxuICogQGRlc2NyaXB0aW9uXG4gKiBFbmNhcHN1bGF0ZXMgYWxsIGRpYWxvZyBoYW5kbGluZyBsb2dpYyBpbmNsdWRpbmc6XG4gKiAtIE1vdmUgZXJyb3IgZGlhbG9nIGFjdGlvbnMgd2l0aCBjb21wbGV4IHVuZG8gYW5kIG9wcG9uZW50IHR1cm4gbG9naWNcbiAqIC0gTW92ZSBzdWNjZXNzIGRpYWxvZyBhY3Rpb25zIGZvciB0cmFpbmluZyBmbG93IGNvbnRpbnVhdGlvblxuICogLSBUcmFpbmluZyBzZXNzaW9uIHJlc2V0IGNvb3JkaW5hdGlvbiBhY3Jvc3MgbXVsdGlwbGUgc2VydmljZXNcbiAqIC0gU3RhdGUgbWFuYWdlbWVudCBmb3Igb3Bwb25lbnQgdHVybnMgYW5kIHBsYXllciBpbnRlcmFjdGlvbnNcbiAqIC0gQ29tcHJlaGVuc2l2ZSBsb2dnaW5nIGFuZCBlcnJvciBoYW5kbGluZ1xuICogXG4gKiBAcmVtYXJrc1xuICogVGhpcyBob29rIG1haW50YWlucyBhbGwgdGhlIGNvbXBsZXggYnVzaW5lc3MgbG9naWMgdGhhdCB3YXMgcHJldmlvdXNseVxuICogZW1iZWRkZWQgaW4gVHJhaW5pbmdCb2FyZC4gSXQgY29vcmRpbmF0ZXMgYmV0d2VlbiBtdWx0aXBsZSBzZXJ2aWNlczpcbiAqIC0gVHJhaW5pbmdTZXNzaW9uIGhvb2tzIGZvciBnYW1lIHN0YXRlIG1hbmFnZW1lbnRcbiAqIC0gU3RvcmUgYWN0aW9ucyBmb3Igc3RhdGUgdXBkYXRlc1xuICogLSBPcHBvbmVudCB0dXJuIG9yY2hlc3RyYXRvcnMgZm9yIHRyYWluaW5nIGZsb3dcbiAqIC0gTG9nZ2luZyBzZXJ2aWNlIGZvciBkZWJ1Z2dpbmcgYW5kIG1vbml0b3JpbmdcbiAqIFxuICogVGhlIGhvb2sgcHJlc2VydmVzIGFsbCBvcmlnaW5hbCBmdW5jdGlvbmFsaXR5IHdoaWxlIHByb3ZpZGluZyBhIGNsZWFuXG4gKiBpbnRlcmZhY2UgdGhhdCBzZXBhcmF0ZXMgY29uY2VybnMgYmV0d2VlbiBkaWFsb2cgYWN0aW9ucyBhbmQgVUkgY29vcmRpbmF0aW9uLlxuICogXG4gKiBAcGFyYW0gcHJvcHMgQ29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBzZXNzaW9uIGZ1bmN0aW9ucywgc3RvcmUgYWN0aW9ucywgYW5kIHN0YXRlXG4gKiBAcmV0dXJucyBPYmplY3Qgd2l0aCBhbGwgZGlhbG9nIGhhbmRsZXIgZnVuY3Rpb25zXG4gKi9cbmV4cG9ydCBjb25zdCB1c2VEaWFsb2dIYW5kbGVycyA9ICh7XG4gIHVuZG9Nb3ZlLFxuICByZXNldEdhbWUsXG4gIGNsZWFyRXZhbHVhdGlvbnMsXG4gIHRyYWluaW5nQWN0aW9ucyxcbiAgZ2FtZUFjdGlvbnMsXG4gIHVpQWN0aW9ucyxcbiAgdHJhaW5pbmdTdGF0ZSxcbiAgc3RvcmVBcGksXG4gIHRyYWluaW5nVUlTdGF0ZSxcbn06IFVzZURpYWxvZ0hhbmRsZXJzUHJvcHMpOiBVc2VEaWFsb2dIYW5kbGVyc1JldHVybiA9PiB7XG5cbiAgLyoqXG4gICAqIFJlc2V0cyB0aGUgdHJhaW5pbmcgYm9hcmQgdG8gaW5pdGlhbCBzdGF0ZVxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogUGVyZm9ybXMgY29tcHJlaGVuc2l2ZSBjbGVhbnVwIGluY2x1ZGluZzpcbiAgICogLSBSZXNldHRpbmcgY2hlc3MgZ2FtZSB0byBzdGFydGluZyBwb3NpdGlvblxuICAgKiAtIENsZWFyaW5nIGFsbCBwb3NpdGlvbiBldmFsdWF0aW9uc1xuICAgKiAtIFJlc2V0dGluZyBVSSBzdGF0ZSBhbmQgZGlhbG9nc1xuICAgKiAtIENsZWFyaW5nIHRyYWluaW5nIHNlc3Npb24gZGF0YVxuICAgKlxuICAgKiBAcmVtYXJrc1xuICAgKiBUaGlzIGhhbmRsZXIgaXMgY2FsbGVkIHdoZW46XG4gICAqIC0gVXNlciBjbGlja3MgcmVzZXQgYnV0dG9uXG4gICAqIC0gVHJhaW5pbmcgc2Vzc2lvbiBuZWVkcyByZXN0YXJ0XG4gICAqIC0gUGFyZW50IGNvbXBvbmVudCB0cmlnZ2VycyByZXNldFxuICAgKi9cbiAgY29uc3QgaGFuZGxlUmVzZXQgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgcmVzZXRHYW1lKCk7XG4gICAgY2xlYXJFdmFsdWF0aW9ucygpO1xuICAgIHRyYWluaW5nVUlTdGF0ZS5oYW5kbGVSZXNldCgpO1xuICAgIGdhbWVBY3Rpb25zLnJlc2V0R2FtZSgpO1xuICAgIC8vIENsZWFyIGV2YWx1YXRpb24gYmFzZWxpbmUgd2hlbiByZXNldHRpbmdcbiAgICB0cmFpbmluZ0FjdGlvbnMuY2xlYXJFdmFsdWF0aW9uQmFzZWxpbmUoKTtcbiAgfSwgW3Jlc2V0R2FtZSwgY2xlYXJFdmFsdWF0aW9ucywgZ2FtZUFjdGlvbnMsIHRyYWluaW5nVUlTdGF0ZSwgdHJhaW5pbmdBY3Rpb25zXSk7XG5cbiAgLyoqXG4gICAqIEhhbmRsZXMgbW92ZSBlcnJvciBkaWFsb2cgZGlzbWlzc2FsIHdpdGggdW5kb1xuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogQ2xvc2VzIHRoZSBtb3ZlIGVycm9yIGRpYWxvZyBhbmQgdW5kb2VzIHRoZSBzdWJvcHRpbWFsIG1vdmUsXG4gICAqIGFsbG93aW5nIHRoZSB1c2VyIHRvIHRyeSBhIGRpZmZlcmVudCBtb3ZlLlxuICAgKlxuICAgKiBAcmVtYXJrc1xuICAgKiBXaGVuIGEgc3Vib3B0aW1hbCBtb3ZlIGlzIGRldGVjdGVkLCBpdCBoYXMgYWxyZWFkeSBiZWVuIGV4ZWN1dGVkXG4gICAqIG9uIHRoZSBib2FyZCBhbmQgYWRkZWQgdG8gdGhlIG1vdmUgaGlzdG9yeS4gVGhpcyBmdW5jdGlvbiByZW1vdmVzXG4gICAqIHRoZSBtb3ZlIGZyb20gaGlzdG9yeSBhbmQgcmV2ZXJ0cyB0aGUgYm9hcmQgcG9zaXRpb24uXG4gICAqL1xuICBjb25zdCBoYW5kbGVNb3ZlRXJyb3JUYWtlQmFjayA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKS5zZXRDb250ZXh0KFwidXNlRGlhbG9nSGFuZGxlcnMtTW92ZUVycm9yXCIpO1xuICAgIGxvZ2dlci5pbmZvKFwiVW5kb2luZyBzdWJvcHRpbWFsIG1vdmUgdXNpbmcgdXNlVHJhaW5pbmdTZXNzaW9uIHVuZG9Nb3ZlXCIpO1xuXG4gICAgLy8gQ1JJVElDQUw6IENhbmNlbCBhbnkgc2NoZWR1bGVkIG9wcG9uZW50IHR1cm4gQkVGT1JFIHVuZG9pbmdcbiAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSBvcHBvbmVudCBmcm9tIHBsYXlpbmcgYWZ0ZXIgd2UgdW5kb1xuICAgIGNhbmNlbFNjaGVkdWxlZE9wcG9uZW50VHVybigpO1xuICAgIGxvZ2dlci5pbmZvKFwiQ2FuY2VsbGVkIGFueSBzY2hlZHVsZWQgb3Bwb25lbnQgdHVyblwiKTtcblxuICAgIC8vIFVzZSB0aGUgdW5kb01vdmUgZnVuY3Rpb24gZnJvbSB1c2VUcmFpbmluZ1Nlc3Npb24gd2hpY2ggcHJvcGVybHkgaGFuZGxlcyBDaGVzc1NlcnZpY2VcbiAgICBjb25zdCB1bmRvUmVzdWx0ID0gdW5kb01vdmUoKTtcblxuICAgIGlmICh1bmRvUmVzdWx0KSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIk1vdmUgc3VjY2Vzc2Z1bGx5IHVuZG9uZVwiKTtcblxuICAgICAgLy8gQ1JJVElDQUw6IFNldCBwbGF5ZXIgdHVybiB0byB0cnVlIGFmdGVyIHVuZG9pbmcgYSBzdWJvcHRpbWFsIG1vdmVcbiAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIG9wcG9uZW50IGZyb20gcGxheWluZyBpbW1lZGlhdGVseSBhZnRlciB1bmRvXG4gICAgICBsb2dnZXIuZGVidWcoXCJCZWZvcmUgc2V0UGxheWVyVHVybiAtIGN1cnJlbnQgc3RhdGVcIiwge1xuICAgICAgICBpc1BsYXllclR1cm46IHRyYWluaW5nU3RhdGUuaXNQbGF5ZXJUdXJuLFxuICAgICAgICBpc09wcG9uZW50VGhpbmtpbmc6IHRyYWluaW5nU3RhdGUuaXNPcHBvbmVudFRoaW5raW5nLFxuICAgICAgfSk7XG4gICAgICB0cmFpbmluZ0FjdGlvbnMuc2V0UGxheWVyVHVybih0cnVlKTtcbiAgICAgIHRyYWluaW5nQWN0aW9ucy5jbGVhck9wcG9uZW50VGhpbmtpbmcoKTsgLy8gQ2xlYXIgb3Bwb25lbnQgdGhpbmtpbmcgZmxhZ1xuICAgICAgdHJhaW5pbmdBY3Rpb25zLmNsZWFyRXZhbHVhdGlvbkJhc2VsaW5lKCk7IC8vIENsZWFyIGJhc2VsaW5lIHNpbmNlIHdlJ3JlIGJhY2sgdG8gb3JpZ2luYWwgcG9zaXRpb25cbiAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICBcIlNldCBwbGF5ZXIgdHVybiB0byB0cnVlLCBjbGVhcmVkIG9wcG9uZW50IHRoaW5raW5nLCBhbmQgY2xlYXJlZCBldmFsdWF0aW9uIGJhc2VsaW5lXCIsXG4gICAgICApO1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiQWZ0ZXIgc2V0UGxheWVyVHVybiBjYWxsXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCJGYWlsZWQgdG8gdW5kbyBtb3ZlIC0gbm8gbW92ZXMgaW4gaGlzdG9yeVwiKTtcbiAgICB9XG5cbiAgICAvLyBDbG9zZSB0aGUgZGlhbG9nIHVzaW5nIHRoZSB0cmFpbmluZ0FjdGlvbnMgaG9vayB3aGljaCBwcm9wZXJseSBhY2Nlc3NlcyB0aGUgYWN0aW9uXG4gICAgLy8gVGhlIGhvb2sgZXh0cmFjdHMgdGhlIGFjdGlvbiBmcm9tIHRoZSBzbGljZSBjcmVhdG9yLCBub3QgZnJvbSB0aGUgbmVzdGVkIHN0b3JlIHN0YXRlXG4gICAgaWYgKHRyYWluaW5nQWN0aW9ucyAmJiB0cmFpbmluZ0FjdGlvbnMuc2V0TW92ZUVycm9yRGlhbG9nKSB7XG4gICAgICB0cmFpbmluZ0FjdGlvbnMuc2V0TW92ZUVycm9yRGlhbG9nKG51bGwpO1xuICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgIFwiU3VjY2Vzc2Z1bGx5IGNsb3NlZCBtb3ZlIGVycm9yIGRpYWxvZyB2aWEgdHJhaW5pbmdBY3Rpb25zIGhvb2tcIixcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcInNldE1vdmVFcnJvckRpYWxvZyBub3QgYXZhaWxhYmxlIGluIHRyYWluaW5nQWN0aW9uc1wiKTtcbiAgICB9XG4gIH0sIFt1bmRvTW92ZSwgdHJhaW5pbmdBY3Rpb25zLCB0cmFpbmluZ1N0YXRlXSk7XG5cbiAgLyoqXG4gICAqIFJlc3RhcnRzIHRoZSBlbnRpcmUgdHJhaW5pbmcgc2Vzc2lvbiBhZnRlciBtb3ZlIGVycm9yXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBDb21wbGV0ZWx5IHJlc2V0cyB0aGUgZ2FtZSBhbmQgY2xvc2VzIHRoZSBlcnJvciBkaWFsb2cgd2hlblxuICAgKiB0aGUgdXNlciBjaG9vc2VzIHRvIHJlc3RhcnQgYWZ0ZXIgbWFraW5nIGEgY3JpdGljYWwgbWlzdGFrZS5cbiAgICpcbiAgICogQHJlbWFya3NcbiAgICogVGhpcyBpcyB0eXBpY2FsbHkgdXNlZCB3aGVuIHRoZSB1c2VyIGhhcyBtYWRlIGEgZ2FtZS1sb3NpbmdcbiAgICogbWlzdGFrZSBhbmQgd2FudHMgdG8gc3RhcnQgdGhlIHBvc2l0aW9uIGZyb20gdGhlIGJlZ2lubmluZy5cbiAgICovXG4gIGNvbnN0IGhhbmRsZU1vdmVFcnJvclJlc3RhcnQgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2VyKCkuc2V0Q29udGV4dChcInVzZURpYWxvZ0hhbmRsZXJzLU1vdmVFcnJvclwiKTtcbiAgICBsb2dnZXIuaW5mbyhcIlJlc3RhcnRpbmcgZ2FtZSBkdWUgdG8gbW92ZSBlcnJvclwiKTtcbiAgICBoYW5kbGVSZXNldCgpO1xuICAgIHRyYWluaW5nQWN0aW9ucy5zZXRNb3ZlRXJyb3JEaWFsb2cobnVsbCk7XG4gIH0sIFtoYW5kbGVSZXNldCwgdHJhaW5pbmdBY3Rpb25zXSk7XG5cbiAgLyoqXG4gICAqIEhhbmRsZXMgXCJXZWl0ZXJzcGllbGVuXCIgKGNvbnRpbnVlIHBsYXlpbmcpIGFjdGlvbiBmcm9tIGVycm9yIGRpYWxvZ1xuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogQ2xvc2VzIHRoZSBlcnJvciBkaWFsb2cgYW5kIHNjaGVkdWxlcyB0aGUgb3Bwb25lbnQncyB0dXJuLlxuICAgKiBUaGlzIGFsbG93cyB0aGUgZ2FtZSB0byBjb250aW51ZSBldmVuIGFmdGVyIGEgc3Vib3B0aW1hbCBtb3ZlLFxuICAgKiBsZXR0aW5nIHRoZSBvcHBvbmVudCByZXNwb25kIHRvIHRoZSBwbGF5ZXIncyBtb3ZlLlxuICAgKlxuICAgKiBAcmVtYXJrc1xuICAgKiBUaGlzIHByb3ZpZGVzIGEgc21vb3RoZXIgdHJhaW5pbmcgZXhwZXJpZW5jZSBieSBhbGxvd2luZyBwbGF5ZXJzXG4gICAqIHRvIGNvbnRpbnVlIHBsYXlpbmcgYW5kIGxlYXJuaW5nIGZyb20gdGhlaXIgbWlzdGFrZXMgcmF0aGVyIHRoYW5cbiAgICogYWx3YXlzIGhhdmluZyB0byB0YWtlIGJhY2sgbW92ZXMuXG4gICAqL1xuICBjb25zdCBoYW5kbGVNb3ZlRXJyb3JDb250aW51ZSA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKS5zZXRDb250ZXh0KFwidXNlRGlhbG9nSGFuZGxlcnMtTW92ZUVycm9yXCIpO1xuICAgIFxuICAgIC8vIEdldCBjdXJyZW50IHN0YXRlIGZvciBkZWJ1Z2dpbmdcbiAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBzdG9yZUFwaS5nZXRTdGF0ZSgpO1xuICAgIGxvZ2dlci5pbmZvKFxuICAgICAgXCLwn46vIFdFSVRFUlNQSUVMRU4gY2xpY2tlZCAtIEN1cnJlbnQgc3RhdGUgQkVGT1JFIGFjdGlvbjpcIixcbiAgICAgIHtcbiAgICAgICAgaXNQbGF5ZXJUdXJuOiBjdXJyZW50U3RhdGUudHJhaW5pbmcuaXNQbGF5ZXJUdXJuLFxuICAgICAgICBpc09wcG9uZW50VGhpbmtpbmc6IGN1cnJlbnRTdGF0ZS50cmFpbmluZy5pc09wcG9uZW50VGhpbmtpbmcsXG4gICAgICAgIGN1cnJlbnRGZW46IGNoZXNzU2VydmljZS5nZXRGZW4oKSxcbiAgICAgICAgY3VycmVudFR1cm46IGNoZXNzU2VydmljZS50dXJuKCksXG4gICAgICAgIGNvbG9yVG9UcmFpbjogY3VycmVudFN0YXRlLnRyYWluaW5nLmN1cnJlbnRQb3NpdGlvbj8uY29sb3JUb1RyYWluLFxuICAgICAgICBtb3ZlQ291bnQ6IGN1cnJlbnRTdGF0ZS5nYW1lLm1vdmVIaXN0b3J5Lmxlbmd0aCxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gQ1JJVElDQUwgRklYOiBTZXQgdHVybiBzdGF0ZSBiZWZvcmUgc2NoZWR1bGluZyBvcHBvbmVudCB0dXJuXG4gICAgLy8gVGhpcyBlbnN1cmVzIHRoZSBvcHBvbmVudCBjYW4gYWN0dWFsbHkgZXhlY3V0ZSB0aGVpciBtb3ZlXG4gICAgY29uc3QgY3VycmVudFR1cm4gPSBjaGVzc1NlcnZpY2UudHVybigpO1xuICAgIGNvbnN0IHRyYWluaW5nQ29sb3IgPSBjdXJyZW50U3RhdGUudHJhaW5pbmcuY3VycmVudFBvc2l0aW9uPy5jb2xvclRvVHJhaW4/LmNoYXJBdCgwKTtcbiAgICBcbiAgICBpZiAoY3VycmVudFR1cm4gIT09IHRyYWluaW5nQ29sb3IpIHtcbiAgICAgIGxvZ2dlci5pbmZvKFwi8J+UpyBGSVhJTkcgQlVHOiBTZXR0aW5nIGlzUGxheWVyVHVybj1mYWxzZSBmb3Igb3Bwb25lbnQgdG8gbW92ZVwiKTtcbiAgICAgIHRyYWluaW5nQWN0aW9ucy5zZXRQbGF5ZXJUdXJuKGZhbHNlKTtcbiAgICB9XG5cbiAgICAvLyBDbG9zZSB0aGUgZXJyb3IgZGlhbG9nXG4gICAgdHJhaW5pbmdBY3Rpb25zLnNldE1vdmVFcnJvckRpYWxvZyhudWxsKTtcbiAgICBsb2dnZXIuaW5mbyhcIuKchSBFcnJvciBkaWFsb2cgY2xvc2VkXCIpO1xuXG4gICAgLy8gU2NoZWR1bGUgb3Bwb25lbnQgdHVybiB0byByZXNwb25kIHRvIHBsYXllcidzIG1vdmVcbiAgICBsb2dnZXIuaW5mbyhcIvCfk4UgQ2FsbGluZyBzY2hlZHVsZU9wcG9uZW50VHVybiB3aXRoIGV2YWx1YXRpb24gYmFzZWxpbmUgY2FsbGJhY2suLi5cIik7XG4gICAgc2NoZWR1bGVPcHBvbmVudFR1cm4oc3RvcmVBcGksIDUwMCwge1xuICAgICAgb25PcHBvbmVudE1vdmVDb21wbGV0ZTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBsb2dnZXIuaW5mbyhcIvCfjq8gT3Bwb25lbnQgbW92ZSBjb21wbGV0ZWQgLSB1cGRhdGluZyBldmFsdWF0aW9uIGJhc2VsaW5lXCIpO1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBHZXQgY3VycmVudCBwb3NpdGlvbiBldmFsdWF0aW9uXG4gICAgICAgICAgY29uc3QgY3VycmVudEZlbiA9IGNoZXNzU2VydmljZS5nZXRGZW4oKTtcbiAgICAgICAgICBjb25zdCBjdXJyZW50RXZhbCA9IGF3YWl0IHRhYmxlYmFzZVNlcnZpY2UuZ2V0RXZhbHVhdGlvbihjdXJyZW50RmVuKTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoY3VycmVudEV2YWwuaXNBdmFpbGFibGUgJiYgY3VycmVudEV2YWwucmVzdWx0KSB7XG4gICAgICAgICAgICAvLyBVcGRhdGUgYmFzZWxpbmUgdG8gY3VycmVudCBwb3NpdGlvbidzIGV2YWx1YXRpb24gdXNpbmcgdGhlIGFjdGlvbnMgcHJvdmlkZWQgdG8gdGhpcyBob29rXG4gICAgICAgICAgICB0cmFpbmluZ0FjdGlvbnMuc2V0RXZhbHVhdGlvbkJhc2VsaW5lKGN1cnJlbnRFdmFsLnJlc3VsdC53ZGwsIGN1cnJlbnRGZW4pO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCLinIUgRXZhbHVhdGlvbiBiYXNlbGluZSB1cGRhdGVkIHN1Y2Nlc3NmdWxseVwiLCB7XG4gICAgICAgICAgICAgIG5ld0Jhc2VsaW5lOiBjdXJyZW50RXZhbC5yZXN1bHQud2RsLFxuICAgICAgICAgICAgICBmZW46IGN1cnJlbnRGZW4sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oXCLimqDvuI8gQ291bGQgbm90IGdldCBldmFsdWF0aW9uIGZvciBiYXNlbGluZSB1cGRhdGUgLSB0YWJsZWJhc2UgdW5hdmFpbGFibGVcIik7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcihcIuKdjCBGYWlsZWQgdG8gdXBkYXRlIGV2YWx1YXRpb24gYmFzZWxpbmU6XCIsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gQ2hlY2sgc3RhdGUgYWZ0ZXIgc2NoZWR1bGluZ1xuICAgIGNvbnN0IHN0YXRlQWZ0ZXIgPSBzdG9yZUFwaS5nZXRTdGF0ZSgpO1xuICAgIGxvZ2dlci5pbmZvKFwi8J+TiiBTdGF0ZSBBRlRFUiBzY2hlZHVsaW5nIG9wcG9uZW50IHR1cm46XCIsIHtcbiAgICAgIGlzUGxheWVyVHVybjogc3RhdGVBZnRlci50cmFpbmluZy5pc1BsYXllclR1cm4sXG4gICAgICBpc09wcG9uZW50VGhpbmtpbmc6IHN0YXRlQWZ0ZXIudHJhaW5pbmcuaXNPcHBvbmVudFRoaW5raW5nLFxuICAgIH0pO1xuICB9LCBbdHJhaW5pbmdBY3Rpb25zLCBzdG9yZUFwaV0pO1xuXG4gIC8qKlxuICAgKiBEaXNwbGF5cyB0aGUgYmVzdCBtb3ZlIGFzIGEgdG9hc3Qgbm90aWZpY2F0aW9uXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBTaG93cyB0aGUgb3B0aW1hbCBtb3ZlIGluIGEgdG9hc3QgbWVzc2FnZSB3aGVuIHRoZSB1c2VyXG4gICAqIHJlcXVlc3RzIHRvIHNlZSB0aGUgYmVzdCBtb3ZlIGFmdGVyIG1ha2luZyBhIG1pc3Rha2UuXG4gICAqXG4gICAqIEByZW1hcmtzXG4gICAqIFRoZSBiZXN0IG1vdmUgaXMgZGV0ZXJtaW5lZCBieSB0YWJsZWJhc2UgYW5hbHlzaXMgYW5kXG4gICAqIHJlcHJlc2VudHMgdGhlIG9iamVjdGl2ZWx5IGJlc3QgY29udGludWF0aW9uIGZyb20gdGhlXG4gICAqIHBvc2l0aW9uIGJlZm9yZSB0aGUgdXNlcidzIHN1Ym9wdGltYWwgbW92ZS5cbiAgICovXG4gIGNvbnN0IGhhbmRsZVNob3dCZXN0TW92ZSA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAodHJhaW5pbmdTdGF0ZS5tb3ZlRXJyb3JEaWFsb2c/LmJlc3RNb3ZlKSB7XG4gICAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnZXIoKS5zZXRDb250ZXh0KFwidXNlRGlhbG9nSGFuZGxlcnMtTW92ZUVycm9yXCIpO1xuICAgICAgbG9nZ2VyLmluZm8oXCJTaG93aW5nIGJlc3QgbW92ZVwiLCB7IGJlc3RNb3ZlOiB0cmFpbmluZ1N0YXRlLm1vdmVFcnJvckRpYWxvZy5iZXN0TW92ZSB9KTtcbiAgICAgIHVpQWN0aW9ucy5zaG93VG9hc3QoXG4gICAgICAgIGBEZXIgYmVzdGUgWnVnIHdhcjogJHt0cmFpbmluZ1N0YXRlLm1vdmVFcnJvckRpYWxvZy5iZXN0TW92ZX1gLFxuICAgICAgICBcImluZm9cIixcbiAgICAgICk7XG4gICAgfVxuICAgIHRyYWluaW5nQWN0aW9ucy5zZXRNb3ZlRXJyb3JEaWFsb2cobnVsbCk7XG4gIH0sIFt0cmFpbmluZ1N0YXRlLm1vdmVFcnJvckRpYWxvZywgdWlBY3Rpb25zLCB0cmFpbmluZ0FjdGlvbnNdKTtcblxuICAvKipcbiAgICogSGFuZGxlcyBzdWNjZXNzIGRpYWxvZyBjbG9zZVxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogQ2xvc2VzIHRoZSBtb3ZlIHN1Y2Nlc3MgZGlhbG9nIHdoZW4gdXNlciBkaXNtaXNzZXMgaXQuXG4gICAqL1xuICBjb25zdCBoYW5kbGVNb3ZlU3VjY2Vzc0Nsb3NlID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIHRyYWluaW5nQWN0aW9ucy5zZXRNb3ZlU3VjY2Vzc0RpYWxvZyhudWxsKTtcbiAgfSwgW3RyYWluaW5nQWN0aW9uc10pO1xuXG4gIC8qKlxuICAgKiBIYW5kbGVzIGNvbnRpbnVpbmcgdG8gbmV4dCBwb3NpdGlvbiBhZnRlciBzdWNjZXNzXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBDbG9zZXMgdGhlIHN1Y2Nlc3MgZGlhbG9nIGFuZCBhbGxvd3MgdHJhaW5pbmcgdG8gY29udGludWUuXG4gICAqIFRyYWluaW5nIGNvbXBsZXRpb24gbG9naWMgaXMgaGFuZGxlZCBlbHNld2hlcmUgaW4gdGhlIHN5c3RlbS5cbiAgICovXG4gIGNvbnN0IGhhbmRsZU1vdmVTdWNjZXNzQ29udGludWUgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgdHJhaW5pbmdBY3Rpb25zLnNldE1vdmVTdWNjZXNzRGlhbG9nKG51bGwpO1xuICAgIC8vIFRyYWluaW5nIGNvbXBsZXRpb24gbG9naWMgaXMgYWxyZWFkeSBoYW5kbGVkIGJ5IFBhd25Qcm9tb3Rpb25IYW5kbGVyXG4gIH0sIFt0cmFpbmluZ0FjdGlvbnNdKTtcblxuICByZXR1cm4ge1xuICAgIGhhbmRsZU1vdmVFcnJvclRha2VCYWNrLFxuICAgIGhhbmRsZU1vdmVFcnJvclJlc3RhcnQsXG4gICAgaGFuZGxlTW92ZUVycm9yQ29udGludWUsXG4gICAgaGFuZGxlU2hvd0Jlc3RNb3ZlLFxuICAgIGhhbmRsZU1vdmVTdWNjZXNzQ2xvc2UsXG4gICAgaGFuZGxlTW92ZVN1Y2Nlc3NDb250aW51ZSxcbiAgICBoYW5kbGVSZXNldCxcbiAgfTtcbn07Il0sIm5hbWVzIjpbInVzZURpYWxvZ0hhbmRsZXJzIiwidW5kb01vdmUiLCJyZXNldEdhbWUiLCJjbGVhckV2YWx1YXRpb25zIiwidHJhaW5pbmdBY3Rpb25zIiwiZ2FtZUFjdGlvbnMiLCJ1aUFjdGlvbnMiLCJ0cmFpbmluZ1N0YXRlIiwic3RvcmVBcGkiLCJ0cmFpbmluZ1VJU3RhdGUiLCJoYW5kbGVSZXNldCIsInVzZUNhbGxiYWNrIiwiY2xlYXJFdmFsdWF0aW9uQmFzZWxpbmUiLCJoYW5kbGVNb3ZlRXJyb3JUYWtlQmFjayIsImxvZ2dlciIsImdldExvZ2dlciIsInNldENvbnRleHQiLCJpbmZvIiwiY2FuY2VsU2NoZWR1bGVkT3Bwb25lbnRUdXJuIiwidW5kb1Jlc3VsdCIsImRlYnVnIiwiaXNQbGF5ZXJUdXJuIiwiaXNPcHBvbmVudFRoaW5raW5nIiwic2V0UGxheWVyVHVybiIsImNsZWFyT3Bwb25lbnRUaGlua2luZyIsImVycm9yIiwic2V0TW92ZUVycm9yRGlhbG9nIiwiaGFuZGxlTW92ZUVycm9yUmVzdGFydCIsImhhbmRsZU1vdmVFcnJvckNvbnRpbnVlIiwiY3VycmVudFN0YXRlIiwiZ2V0U3RhdGUiLCJ0cmFpbmluZyIsImN1cnJlbnRGZW4iLCJjaGVzc1NlcnZpY2UiLCJnZXRGZW4iLCJjdXJyZW50VHVybiIsInR1cm4iLCJjb2xvclRvVHJhaW4iLCJjdXJyZW50UG9zaXRpb24iLCJtb3ZlQ291bnQiLCJnYW1lIiwibW92ZUhpc3RvcnkiLCJsZW5ndGgiLCJ0cmFpbmluZ0NvbG9yIiwiY2hhckF0Iiwic2NoZWR1bGVPcHBvbmVudFR1cm4iLCJvbk9wcG9uZW50TW92ZUNvbXBsZXRlIiwiY3VycmVudEV2YWwiLCJ0YWJsZWJhc2VTZXJ2aWNlIiwiZ2V0RXZhbHVhdGlvbiIsImlzQXZhaWxhYmxlIiwicmVzdWx0Iiwic2V0RXZhbHVhdGlvbkJhc2VsaW5lIiwid2RsIiwibmV3QmFzZWxpbmUiLCJmZW4iLCJ3YXJuIiwic3RhdGVBZnRlciIsImhhbmRsZVNob3dCZXN0TW92ZSIsIm1vdmVFcnJvckRpYWxvZyIsImJlc3RNb3ZlIiwic2hvd1RvYXN0IiwiaGFuZGxlTW92ZVN1Y2Nlc3NDbG9zZSIsInNldE1vdmVTdWNjZXNzRGlhbG9nIiwiaGFuZGxlTW92ZVN1Y2Nlc3NDb250aW51ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQTZDQzs7OzsrQkF3SVlBOzs7ZUFBQUE7Ozt1QkF0SWU7d0JBQ0Y7a0NBSW5COzhCQUNzQjtrQ0FDSTtBQStIMUIsTUFBTUEsb0JBQW9CLENBQUMsRUFDaENDLFFBQVEsRUFDUkMsU0FBUyxFQUNUQyxnQkFBZ0IsRUFDaEJDLGVBQWUsRUFDZkMsV0FBVyxFQUNYQyxTQUFTLEVBQ1RDLGFBQWEsRUFDYkMsUUFBUSxFQUNSQyxlQUFlLEVBQ1E7SUFFdkI7Ozs7Ozs7Ozs7Ozs7OztHQWVDLEdBQ0QsTUFBTUMsY0FBY0MsSUFBQUEsa0JBQVcsRUFBQztRQUM5QlQ7UUFDQUM7UUFDQU0sZ0JBQWdCQyxXQUFXO1FBQzNCTCxZQUFZSCxTQUFTO1FBQ3JCLDJDQUEyQztRQUMzQ0UsZ0JBQWdCUSx1QkFBdUI7SUFDekMsR0FBRztRQUFDVjtRQUFXQztRQUFrQkU7UUFBYUk7UUFBaUJMO0tBQWdCO0lBRS9FOzs7Ozs7Ozs7OztHQVdDLEdBQ0QsTUFBTVMsMEJBQTBCRixJQUFBQSxrQkFBVyxFQUFDO1FBQzFDLE1BQU1HLFNBQVNDLElBQUFBLGlCQUFTLElBQUdDLFVBQVUsQ0FBQztRQUN0Q0YsT0FBT0csSUFBSSxDQUFDO1FBRVosOERBQThEO1FBQzlELHdEQUF3RDtRQUN4REMsSUFBQUEsNkNBQTJCO1FBQzNCSixPQUFPRyxJQUFJLENBQUM7UUFFWix3RkFBd0Y7UUFDeEYsTUFBTUUsYUFBYWxCO1FBRW5C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