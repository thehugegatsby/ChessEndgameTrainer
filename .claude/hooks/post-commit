#!/bin/bash

# Git post-commit hook for capturing learnings
# This hook prompts to document important learnings after commits

# Colors for terminal output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Only run in interactive terminals
if [ -t 1 ]; then
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}🧠 Learning Opportunity Check${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    
    # Get commit info
    COMMIT_HASH=$(git rev-parse HEAD)
    COMMIT_MSG=$(git log -1 --pretty=%B)
    CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
    
    echo "Commit: ${COMMIT_HASH:0:7} - ${COMMIT_MSG:0:50}..."
    echo ""
    echo "Did this commit reveal an important learning?"
    echo "(e.g., bug pattern, architecture insight, performance finding)"
    echo ""
    read -p "Document a learning? (y/N): " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}Opening learning documentation helper...${NC}"
        
        # Create a temporary file with context
        TEMP_FILE="/tmp/learning_context_$(date +%s).txt"
        
        cat > "$TEMP_FILE" << EOF
# Learning Context for Claude Code

## Commit Information
- Hash: ${COMMIT_HASH}
- Message: ${COMMIT_MSG}
- Date: $(date '+%Y-%m-%d %H:%M')

## Changed Files
${CHANGED_FILES}

## Instructions for Claude
Please help document this learning by:
1. Asking me what was learned
2. Identifying the category (Architecture, Bug Fix, Performance, Testing, Security, Pattern)
3. Creating a properly formatted entry for LEARNINGS.md

## Format Template
\`\`\`yaml
---
date: $(date '+%Y-%m-%d %H:%M')
category: [Category]
tags: [relevant, tags]
commit: ${COMMIT_HASH:0:7}
files: [affected files]
confidence: [high | medium | low]
---
\`\`\`

### Discovery
[What was discovered]

### Context
[Why this matters]

### Implementation
[How it was applied]

### Future Considerations
[What to watch for]
EOF
        
        echo ""
        echo "Context saved to: $TEMP_FILE"
        echo ""
        echo -e "${YELLOW}Next steps:${NC}"
        echo "1. Tell Claude: 'Help me document a learning from commit ${COMMIT_HASH:0:7}'"
        echo "2. Claude can read the context from: $TEMP_FILE"
        echo "3. Describe what you learned, and Claude will format it for LEARNINGS.md"
        echo ""
        echo -e "${GREEN}Happy learning! 🎓${NC}"
    fi
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
fi